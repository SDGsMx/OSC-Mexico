rm(list=ls())
suppressPackageStartupMessages({
library(stringr)
library(tidyverse)
require(curl)
require(gdata)
source("./utils.R")
library(readxl)
})
###################
# Descarga
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Construir Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
summary(organizaciones)
rm(list=ls())
suppressPackageStartupMessages({
library(stringr)
library(tidyverse)
require(curl)
require(gdata)
source("./utils.R")
library(readxl)
})
###################
# Descarga
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Construir Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
organizaciones
colnames(organizaciones)
library(ggmap)
domicilios = organizaciones$domicilio
domicilios
domicilios = organizaciones$domicilio_fiscal
domicilios
domicilios = paste0(addresses, ", México")
domicilios = paste0(domicilios, ", México")
source("./utils.R")
geocoded <- data.frame()
startindex <- 1
tempfilename <- paste0(infile, '_temp_geocoded.rds')
if (file.exists(tempfilename)){
print("Found temp file - resuming from index:")
geocoded <- readRDS(tempfilename)
startindex <- nrow(geocoded)
print(startindex)
}
for (ii in seq(startindex, length(addresses))){
print(paste("Working on index", ii, "of", length(addresses)))
#query the google geocoder - this will pause here if we are over the limit.
result = getGeoDetails(addresses[ii])
print(result$status)
result$index <- ii
#append the answer to the results file.
geocoded <- rbind(geocoded, result)
#save temporary results as we are going along
saveRDS(geocoded, tempfilename)
}
geocoded <- data.frame()
startindex <- 1
tempfilename <- paste0(infile, '_temp_geocoded.rds')
if (file.exists(tempfilename)){
print("Found temp file - resuming from index:")
geocoded <- readRDS(tempfilename)
startindex <- nrow(geocoded)
print(startindex)
}
for (ii in seq(startindex, length(domicilios))){
print(paste("Working on index", ii, "of", length(domicilios)))
#query the google geocoder - this will pause here if we are over the limit.
result = getGeoDetails(domicilios[ii])
print(result$status)
result$index <- ii
#append the answer to the results file.
geocoded <- rbind(geocoded, result)
#save temporary results as we are going along
saveRDS(geocoded, tempfilename)
}
infile <- "input"
tempfilename <- paste0(infile, '_temp_geocoded.rds')
if (file.exists(tempfilename)){
print("Found temp file - resuming from index:")
geocoded <- readRDS(tempfilename)
startindex <- nrow(geocoded)
print(startindex)
}
for (ii in seq(startindex, length(domicilios))){
print(paste("Working on index", ii, "of", length(domicilios)))
#query the google geocoder - this will pause here if we are over the limit.
result = getGeoDetails(domicilios[ii])
print(result$status)
result$index <- ii
#append the answer to the results file.
geocoded <- rbind(geocoded, result)
#save temporary results as we are going along
saveRDS(geocoded, tempfilename)
}
geocoded
colnames(geocoded)
head(geocoded)
organizaciones$domicilio_fiscal
length(organizaciones$domicilio_fiscal)
length(unique(organizaciones$domicilio_fiscal))
domicilios = organizaciones$domicilio_fiscal
domicilios = paste0(domicilios, ", México")
domicilios
infile <- "input"
geocode_vector_process(infile,domicilios)
source("./utils.R")
geocode_vector_process(infile,domicilios)
temp <- readRDS("input_temp_geocoded.rds")
temp
head(temp)
rm(list=ls())
source("./utils.R")
###################
# Download
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Clean/Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Create Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
summary(organizaciones)
glimpse(organizaciones)
organizaciones %>% count(ctividad_o_fin)
organizaciones %>% dplyr::count(ctividad_o_fin)
organizaciones %>% dplyr::count(actividad_o_fin)
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot(aes(actividad_o_fin,n)) %>%
geom_bar()
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot() %>%
geom_bar(aes(actividad_o_fin,n))
organizaciones %>% dplyr::count(actividad_o_fin) %>%
mutate(actividad_o_fin=factor(actividad_o_fin)) %>% ggplot(aes(actividad_o_fin,n)) %>%
geom_bar()
organizaciones %>% dplyr::count(actividad_o_fin) %>%
mutate(actividad_o_fin=factor(actividad_o_fin)) %>% ggplot() %>%
geom_bar(aes(actividad_o_fin,n))
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot() %>%
geom_bar(factor(actividad_o_fin))
organizaciones %>% dplyr::count(actividad_o_fin)
organizaciones %>% dplyr::count(actividad_o_fin) %>% dplyr::select(actividad_o_fin)
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot() %>%
geom_bar(factor(n))
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot() %>%
geom_bar(factor(n))
organizaciones %>% ggplot() %>%
geom_bar(actividad_o_fin)
organizaciones %>% ggplot() %>%
geom_bar(aes(actividad_o_fin))
organizaciones %>% ggplot() %>%
geom_bar(aes(factor(actividad_o_fin)))
organizaciones %>% ggplot(aes(x=actividad_o_fin)) %>% stat_count()
organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count()
organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count()
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot(aes(actividad_o_fin,n)) +
geom_bar()
organizaciones %>% dplyr::count(actividad_o_fin) %>% ggplot(aes(actividad_o_fin)) +
geom_bar()
organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count()
install.packages("wesanderson")
library(wesanderson)
sp <- organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count()
sp+scale_color_manual(values=wes_palette(n=3, name="GrandBudapest"))
sp + scale_color_manual(values=wes_palette(n=3, name="GrandBudapest"))
sp <- organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count()
sp + scale_color_manual(values=wes_palette(n=8, name="GrandBudapest"))
organizaciones %>% ggplot(aes(x=actividad_o_fin)) + stat_count() +
scale_fill_brewer()
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
scale_fill_brewer(palette="Set1")
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count()
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
scale_fill_brewer(palette="Set1")
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count()
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
scale_fill_brewer()
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count()
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count()+
labs(fill="Serologic response")
dic <- read_csv("./dir163_dic.csv")
dic
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count()+
labs(fill="Actividad o Fin Autorizado")
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado")
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado") + theme(legend.position='none')
organizaciones %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado") + theme(legend.position='none')+ylab("Número de Organizaciones")
colnames(organizaciones)
organizaciones %>% count(actividad_o_fin,rfc) %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado") + theme(legend.position='none')+ylab("Número de Organizaciones") +
ggsave(file="../img/fin_autorizado.png")
rm(list=ls())
source("./utils.R")
###################
# Download
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Clean/Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Create Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
###################
# Batch Geocode
###################
domicilios = organizaciones$domicilio_fiscal
domicilios = paste0(domicilios, ", México")
infile <- "input"
geocode_vector_process(infile,domicilios)
organizaciones %>% filter(actividad_o_fin!="M") %>%
count(ac,sc,scp,abp,iap,fideicomiso,banco,fundacion,iasp,ibp)%>% View()
library(printr)
install.packages("printr")
library(printr)
tmp<-organizaciones %>% filter(actividad_o_fin!="M") %>%
count(ac,sc,scp,abp,iap,fideicomiso,banco,fundacion,iasp,ibp)
knitr::kable(tmp,format="html")
knitr::kable(tmp)
rm(list=ls())
source("./utils.R")
###################
# Download
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Clean/Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Create Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
###################
# Batch Geocode
###################
domicilios = organizaciones$domicilio_fiscal
domicilios = paste0(domicilios, ", México")
infile <- "input"
geocode_vector_process(infile,domicilios)
geocode_vector_process(infile,domicilios)
rm(list=ls())
source("./utils.R")
###################
# Download
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Clean/Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Create Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
#glimpse(organizaciones)
#summary(organizaciones)
###################
# Batch Geocode
###################
domicilios = organizaciones$domicilio_fiscal
geocoded <- readRDS("input_temp_geocoded.rds")
geocoded
geocoded
tail(geocoded)
domicilios = organizaciones$domicilio_fiscal
domicilios = paste0(domicilios, ", México")
infile <- "input"
geocode_vector_process(infile,domicilios)
rm(list=ls())
source("./utils.R")
rm(list=ls())
source("./utils.R")
###################
# Download
###################
# Descarga Directorio actualizado del SAT
# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx
con <- "http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls"
organizaciones <- load(con,"directorio_donatarias")
###################
# Clean/Recode
###################
organizaciones <- clean(organizaciones)
#summary(organizaciones)
#glimpse(organizaciones)
###################
# Create Denominaciones Sociales
###################
organizaciones <- organizaciones %>%
mutate(razon_social=str_to_lower(razon_social)) %>%
mutate(tipo_social = str_extract(razon_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|:)*(\\s)*]*+$|a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*L(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*$|s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*$")) %>%
mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%
mutate(iasp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*s(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(fideicomiso = ifelse(str_detect(razon_social,"[f|f]ideicomiso"),1,0)) %>%
mutate(ac = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*c(\\s)*[(\\.|\\,|\\:)*(\\s)*]*"),1,0)) %>%
mutate(sc = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*"),1,0))%>%
mutate(scp = ifelse(str_detect(tipo_social,"s(\\s)*(\\.|\\,)*(\\s)*c(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(abp = ifelse(str_detect(tipo_social,"a(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(fbp = ifelse(str_detect(tipo_social,"f(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0)) %>%
mutate(iap = ifelse(str_detect(tipo_social,"i(\\s)*(\\.|\\,)*(\\s)*a(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(ibp = ifelse(str_detect(razon_social,"i(\\s)*(\\.|\\,)*(\\s)*b(\\s)*(\\.|\\,)*(\\s)*p(\\s)*(\\.|\\,)*(\\s)*"),1,0))  %>%
mutate(banco = ifelse(str_detect(razon_social,"banco"),1,0)) %>%
mutate(fundacion = ifelse(str_detect(razon_social,"fundaci[o|ó]n"),1,0))
organizaciones
organizaciones %>% View()
organizaciones %>% count(actividad_o_fin,rfc) %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado") + theme(legend.position='none')+ylab("Número de Organizaciones") +
ggsave(file="../img/fin_autorizado.png")
organizaciones %>% count(actividad_o_fin,rfc)
organizaciones %>% count(actividad_o_fin,rfc) %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() +
xlab("Actividad o Fin Autorizado") + theme(legend.position='none')+ylab("Número de Organizaciones")
glimpse(organizaciones)
tmp<-organizaciones %>% filter(actividad_o_fin!="M") %>%
count(ac,sc,scp,abp,iap,fideicomiso,banco,fundacion,iasp,ibp)
knitr::kable(tmp)
tmp
tmp
tmp$n
sum(tmp$n)
organizaciones %>% filter(ac==0,sc==0,scp==0,abp==0,iap==0,fideicomiso==0,banco==0,fundacion==0,iasp==0,ibp==0)
organizaciones %>% filter(ac==0,sc==0,scp==0,abp==0,iap==0,fideicomiso==0,banco==0,fundacion==0,iasp==0,ibp==0) %>%
write.csv(faltantes.csv)
organizaciones %>% filter(ac==0,sc==0,scp==0,abp==0,iap==0,fideicomiso==0,banco==0,fundacion==0,iasp==0,ibp==0) %>%
write.csv("faltantes.csv",row.names = FALSE)
organizaciones %>% filter(ac==0,sc==0,scp==0,abp==0,iap==0,fideicomiso==0,banco==0,fundacion==0,iasp==0,ibp==0)
tmp
tmp
tmp %>% View()
organizaciones %>% filter(ac==0&sc==0&scp==0&abp==0&iap==0&fideicomiso==0&banco==0&fundacion==0&iasp==0&ibp==0) %>%
write.csv("faltantes.csv",row.names = FALSE)
organizaciones %>% filter(ac==0&sc==0&scp==0&abp==0&iap==0&fideicomiso==0&banco==0&fundacion==0&iasp==0&ibp==0)
organizaciones %>% filter(actividad_o_fin!="M") %>%  filter(ac==0&sc==0&scp==0&abp==0&iap==0&fideicomiso==0&banco==0&fundacion==0&iasp==0&ibp==0)
organizaciones %>% filter(actividad_o_fin!="M") %>%  filter(ac==0&sc==0&scp==0&abp==0&iap==0&fideicomiso==0&banco==0&fundacion==0&iasp==0&ibp==0) %>%
write.csv("faltantes.csv",row.names = FALSE)
