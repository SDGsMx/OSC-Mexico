{
    "collab_server" : "",
    "contents" : "rm(list=ls())\nsource(\"./utils.R\")\n\n###################\n# Download\n###################\n# Descarga Directorio actualizado del SAT \n# Obtenido de http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Paginas/directorio_2017.aspx\ncon <- \"http://www.sat.gob.mx/terceros_autorizados/donatarias_donaciones/Documents/dir163.xls\"\norganizaciones <- load(con,\"directorio_donatarias\")\n\n###################\n# Clean/Recode\n###################\norganizaciones <- clean(organizaciones)\n#summary(organizaciones)\n#glimpse(organizaciones)\n\n###################\n# Create Denominaciones Sociales\n###################\n\norganizaciones <- organizaciones %>% \n  mutate(razon_social=str_to_lower(razon_social)) %>%\n  mutate(tipo_social = str_extract(razon_social,\"a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*[(\\\\.|\\\\,|:)*(\\\\s)*]*+$|a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*b(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|i(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|f(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*b(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|i(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*L(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$|s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*$\")) %>%\n  mutate(tipo_social = ifelse(is.na(tipo_social)==T,yes=0,no=tipo_social)) %>%\n  mutate(iasp = ifelse(str_detect(razon_social,\"i(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0))  %>% \n  mutate(fideicomiso = ifelse(str_detect(razon_social,\"[f|f]ideicomiso\"),1,0)) %>%\n  mutate(ac = ifelse(str_detect(tipo_social,\"a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*[(\\\\.|\\\\,|\\\\:)*(\\\\s)*]*\"),1,0)) %>%\n  mutate(sc = ifelse(str_detect(tipo_social,\"s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0))%>% \n  mutate(scp = ifelse(str_detect(tipo_social,\"s(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*c(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0)) %>%\n  mutate(abp = ifelse(str_detect(tipo_social,\"a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*b(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0)) %>%\n  mutate(fbp = ifelse(str_detect(tipo_social,\"f(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*b(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0)) %>%\n  mutate(iap = ifelse(str_detect(tipo_social,\"i(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*a(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0))  %>% \n  mutate(ibp = ifelse(str_detect(razon_social,\"i(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*b(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*p(\\\\s)*(\\\\.|\\\\,)*(\\\\s)*\"),1,0))  %>% \n  mutate(banco = ifelse(str_detect(razon_social,\"banco\"),1,0)) %>%\n  mutate(fundacion = ifelse(str_detect(razon_social,\"fundaci[o|ó]n\"),1,0))\n\n#glimpse(organizaciones)\n#summary(organizaciones)\n\n###################\n# Batch Geocode\n###################\ndomicilios = organizaciones$domicilio_fiscal\ndomicilios = paste0(domicilios, \", México\")\ninfile <- \"input\"\n\ngeocode_vector_process(infile,domicilios)\ngeocoded <- readRDS(\"input_temp_geocoded.rds\")\n\n# Add the latitude and longitude to the main data\norganizaciones$lat <- geocoded$lat\norganizaciones$long <- geocoded$lat\norganizaciones$accuracy <- geocoded$accuracy\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n###################\n# Shameful EDA\n###################\norganizaciones %>% count(actividad_o_fin,rfc) %>% ggplot(aes(x=actividad_o_fin,fill=actividad_o_fin)) + stat_count() + \n  xlab(\"Actividad o Fin Autorizado\") + theme(legend.position='none')+ylab(\"Número de Organizaciones\") +\n  ggsave(file=\"../img/fin_autorizado.png\")\n\n#+ labs(fill=\"Actividad o Fin Autorizado\") +xlab(\"Act\") +ylab(\"number of subjects\") \n\ntmp<-organizaciones %>% filter(actividad_o_fin!=\"M\") %>% \n  count(ac,sc,scp,abp,iap,fideicomiso,banco,fundacion,iasp,ibp)\nknitr::kable(tmp)\n\norganizaciones %>% filter(actividad_o_fin!=\"M\") %>% \n  filter(is.na(ac)==T&is.na(sc)==T&is.na(scp)==T&is.na(abp)==T&is.na(fbp)==T&\n           is.na(iap)==T&fideicomiso==0&banco==0&fundacion==0&ibp==0) %>% \n  #View()\n  write.csv(\"temp.csv\")\n\n\norganizaciones %>% filter(actividad_o_fin!=\"M\") %>% count(AC,IAP)%>% View()\n\norganizaciones %>% filter(actividad_o_fin!=\"M\") %>% count(AC,IAPZ)%>% View()\n\norganizaciones %>% filter(actividad_o_fin!=\"M\") %>% count(AC)%>% View()\n\norganizaciones %>% filter(actividad_o_fin!=\"M\" & is.na(AC)) %>% write.csv(\"acs_135.csv\")\n\n# AC's con M y RFC único\n\ndata %>% dplyr::filter(`ACTIVIDAD O FIN AUTORIZADO`!=\"M\" & AC==1) %>% count(RFC)\ndata %>% count(IAP) \n\ndata <- data %>% mutate(tipo_social = str_extract(`DENOMINACIÓN O RAZÓN SOCIAL`,\"A(\\\\s)*(\\\\.)*(\\\\s)*C(\\\\s)*(\\\\.)*(\\\\s)*$|A(\\\\s)*(\\\\.)*(\\\\s)*B(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*$|I(\\\\s)*(\\\\.)*(\\\\s)*A(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*$|F(\\\\s)*(\\\\.)*(\\\\s)*B(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*$|I(\\\\s)*(\\\\.)*(\\\\s)*A(\\\\s)*(\\\\.)*(\\\\s)*S(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*$|S(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*L(\\\\s)*(\\\\.)*(\\\\s)*$|S(\\\\s)*(\\\\.)*(\\\\s)*C(\\\\s)*(\\\\.)*(\\\\s)*$|S(\\\\s)*(\\\\.)*(\\\\s)*C(\\\\s)*(\\\\.)*(\\\\s)*P(\\\\s)*(\\\\.)*(\\\\s)*$\")) %>% \n  mutate(AC = ifelse(str_detect(tipo_social,\"A(\\\\s)*(\\\\.)*(\\\\s)*C(\\\\s)*(\\\\.)*(\\\\s)*\"),1,0))%>% \n  mutate(VIVIENDA = ifelse(str_detect(`OBJETO SOCIAL AUTORIZADO`,\"VIVIENDA|TECHO|CASA\"),1,0))\n\n\ndata %>% count(tipo_social) %>% View()\ndata %>% filter(is.na(tipo_social)==TRUE) %>%count(`DENOMINACIÓN O RAZÓN SOCIAL`) %>% View()\n\n\n# AC's\n# 9866\ndata %>% filter(grepl(\"A(\\\\s)*\\\\.(\\\\s)*C(\\\\s)*\\\\.(\\\\s)*$\",`DENOMINACIÓN O RAZÓN SOCIAL`,ignore.case = TRUE)) %>% \n  select(`DENOMINACIÓN O RAZÓN SOCIAL`)\n\n# Sin M 7,329\ndata %>% filter(grepl(\"A(\\\\s)*\\\\.(\\\\s)*C(\\\\s)*\\\\.(\\\\s)*$\",`DENOMINACIÓN O RAZÓN SOCIAL`,ignore.case = TRUE)) %>% \n  filter(`ACTIVIDAD O FIN AUTORIZADO`!=\"M\")\n\ndata %>% count(RFC)\n\ndata %>% count(`DENOMINACIÓN O RAZÓN SOCIAL`) %>% arrange(-n)\n\n# https://radishlab.com/2016/09/using-carto-for-creating-data-driven-web-pages/",
    "created" : 1488246303517.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "85911433",
    "id" : "BA5D34A6",
    "lastKnownWriteTime" : 1486335074,
    "last_content_update" : 1486335074,
    "path" : "~/workspace/organizaciones_sociedad_civil/analisis/analisis_acs.R",
    "project_path" : "analisis_acs.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}